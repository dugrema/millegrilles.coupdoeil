#!/usr/bin/env node
const debug = require('debug')('millegrilles:coupdoeil:www')
const express = require('express')
const session = require('express-session')
const MemoryStore = require('memorystore')(session)
const socketioSession = require('express-socket.io-session')

const socketApp = require('../models/appSocketIo')
const amqpdao = require('../models/amqpdao')
// const {initialiser: initialiserServer} = require('@dugrema/millegrilles.common/lib/server3')
const server4 = require('@dugrema/millegrilles.common/lib/server4')
const {initialiser: initialiserCoupdoeil} = require('../routes/coupdoeil')
// const { GrosFichiersDao } = require('../models/grosFichiersDao')

async function init() {

  // Initialiser server et routes
  const app = express()
  const {server, socketIo, amqpdao: amqpdaoInst} = await server4(
    app, socketApp.configurerEvenements, {pathApp: '/coupdoeil'})

  // const grosFichiersDao = new GrosFichiersDao(amqpdaoInst)
  // socketIo.use((socket, next)=>{
  //   socket.grosFichiersDao = grosFichiersDao
  //   next()
  // })

  const routeCoupdoeil = express.Router()
  app.use('/coupdoeil', routeCoupdoeil)

  // // Inserer les routes apres l'initialisation, permet d'avoir le middleware
  // // attache avant (app.use comme le logging morgan, injection amqpdao, etc.)
  // routeGrosfichiers.use((req, res, next)=>{
  //   req.grosFichiersDao = grosFichiersDao
  //   next()
  // })

  routeCoupdoeil.use(initialiserCoupdoeil(amqpdaoInst))

}

init()
